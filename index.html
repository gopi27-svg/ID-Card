<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern ID Request Form (Reliable Upload)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    :root{--primary-color:#007bff;--secondary-color:#6c757d;--background-color:#f4f7f6;--form-bg-color:rgba(255,255,255,0.95);--text-color:#333;--border-color:#ced4da;--error-color:#dc3545}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--background-color);background-image:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);display:flex;justify-content:center;align-items:center;min-height:100vh;padding:2rem;color:var(--text-color)}
    .form-container{width:100%;max-width:750px;background:var(--form-bg-color);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.1);overflow:hidden;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    #id-request-form{padding:2.5rem 3rem}
    .form-header{text-align:center;margin-bottom:2rem}
    .company-logo{max-width:170px;margin-bottom:0.1rem}
    .form-header h2{font-size:2rem;font-weight:600;margin-bottom:0.5rem}
    .form-header p{color:var(--secondary-color)}
    .progress-bar{display:flex;justify-content:space-between;list-style:none;margin-bottom:2.5rem;position:relative}
    .progress-bar .step{text-align:center;width:33.33%;position:relative}
    .progress-bar .step .icon{height:40px;width:40px;border:2px solid var(--border-color);border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:500;background-color:#fff;margin:0 auto 0.5rem;transition:all 0.3s ease}
    .progress-bar .step.active .icon{background-color:var(--primary-color);border-color:var(--primary-color);color:#fff}
    .progress-bar .step p{font-size:0.9rem;font-weight:500;color:var(--secondary-color);transition:all 0.3s ease}
    .progress-bar .step.active p{color:var(--primary-color)}
    .progress-bar::before{content:'';position:absolute;top:20px;left:16.66%;width:66.66%;height:3px;background-color:var(--border-color);z-index:-1}
    #progress-line{position:absolute;top:20px;left:16.66%;width:0%;height:3px;background-color:var(--primary-color);z-index:-1;transition:width 0.3s ease}
    .form-step{display:none}
    .form-step.active{display:block;animation:fadeIn 0.5s ease-in-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .form-group{margin-bottom:1.5rem}
    label{display:block;margin-bottom:0.5rem;font-weight:500}
    input,select,textarea{width:100%;padding:0.75rem 1rem;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;font-family:'Poppins',sans-serif;transition:border-color 0.2s,box-shadow 0.2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,123,255,0.15)}
    input.invalid,select.invalid,textarea.invalid{border-color:var(--error-color);box-shadow:0 0 0 3px rgba(220,53,69,0.15)}
    textarea{resize:vertical;min-height:100px}
    .file-upload-area{border:2px dashed var(--border-color);border-radius:8px;padding:2rem;text-align:center;cursor:pointer;transition:border-color 0.2s,background-color 0.2s}
    .file-upload-area:hover{border-color:var(--primary-color);background-color:#f8f9fa}
    .file-upload-area.invalid{border-color:var(--error-color)}
    .file-upload-area .upload-icon{font-size:2.5rem;color:var(--primary-color)}
    .file-upload-area p{margin-top:1rem;color:var(--secondary-color)}
    #photo-upload{display:none}
    #photo-preview-container{margin-top:1rem;text-align:center;display:none}
    #photo-preview{max-width:150px;max-height:150px;border-radius:8px;border:1px solid var(--border-color)}
    .button-group{display:flex;justify-content:space-between;margin-top:2.5rem}
    .btn{padding:0.75rem 1.5rem;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:all 0.3s ease}
    .btn-primary{background-color:var(--primary-color);color:#fff}
    .btn-primary:hover{background-color:#0056b3;transform:translateY(-2px)}
    .btn-secondary{background-color:var(--secondary-color);color:#fff}
    .btn-secondary:hover{background-color:#5a6268}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .spinner{width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;display:inline-block;margin-left:8px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #thankyou-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    #thankyou-card{background:#fff;border-radius:14px;max-width:560px;width:90%;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center}
    #thankyou-card h3{margin-bottom:.5rem;font-family:'Poppins',sans-serif}
    #thankyou-card p{color:#555;line-height:1.5}
    #thankyou-close{margin-top:1rem;padding:.6rem 1.2rem;border:none;border-radius:8px;background:var(--primary-color);color:#fff;cursor:pointer}
    #thankyou-close:hover{background:#0056b3}
    @media (max-width:768px){#id-request-form{padding:2rem 1.5rem}.form-header h2{font-size:1.5rem}.progress-bar .step p{font-size:0.8rem}}
  </style>
</head>
<body>
  <div class="form-container">
    <form id="id-request-form" novalidate>
      <div class="form-header">
        <img src="https://i.postimg.cc/pTJQwfkV/USDC-Logo.png" alt="Company Logo" class="company-logo">
        <h2>Company ID Request Form</h2>
        <p>Please fill out the form to request your new ID card.</p>
      </div>
      <ul class="progress-bar">
        <div id="progress-line"></div>
        <li class="step active"><div class="icon">1</div><p>Personal</p></li>
        <li class="step"><div class="icon">2</div><p>Contact</p></li>
        <li class="step"><div class="icon">3</div><p>Emergency</p></li>
      </ul>
      <div class="form-step active">
        <div class="form-group"><label for="entity">Entity</label><select id="entity" name="entity" required><option value="" disabled selected>Select your entity</option><option value="usdc">USDC</option><option value="learn-online">Learn Online</option></select></div>
        <div class="form-group"><label for="name">Full Name</label><input type="text" id="name" name="name" placeholder="Enter your full name" required></div>
        <div class="form-group"><label for="designation">Designation</label><input type="text" id="designation" name="designation" placeholder="e.g., Software Engineer" required></div>
        <div class="form-group"><label for="emp-code">Employee Code</label><input type="text" id="emp-code" name="emp-code" placeholder="e.g., USDC12345" required></div>
      </div>
      <div class="form-step">
        <div class="form-group"><label for="photo-upload">Photo (Passport Size)</label><label for="photo-upload" class="file-upload-area"><div class="upload-icon">‚¨ÜÔ∏è</div><p><b>Click to upload</b> or drag and drop</p><p><small>PNG, JPG, or JPEG (MAX. 5MB)</small></p></label><input type="file" id="photo-upload" name="photo" accept="image/png, image/jpeg, image/jpg" required><div id="photo-preview-container"><img id="photo-preview" src="#" alt="Photo Preview"/></div></div>
        <div class="form-group"><label for="contact-number">Personal Contact Number (10 digits)</label><input type="tel" id="contact-number" name="contact-number" placeholder="e.g., 9876543210" required pattern="[0-9]{10}" title="Please enter a 10-digit phone number."></div>
        <div class="form-group"><label for="present-address">Present Address</label><textarea id="present-address" name="present-address" placeholder="Your current residential address" required></textarea></div>
        <div class="form-group"><label for="office-address">Office Address</label><textarea id="office-address" name="office-address" placeholder="Your office location" required></textarea></div>
      </div>
      <div class="form-step">
        <div class="form-group"><label for="blood-group">Blood Group</label><select id="blood-group" name="blood-group" required><option value="" disabled selected>Select blood group</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option><option value="O+">O+</option><option value="O-">O-</option></select></div>
        <div class="form-group"><label for="emergency-contact">Emergency Contact Number </label><input type="tel" id="emergency-contact" name="emergency-contact" placeholder="e.g., 9876543210" required pattern="[0-9]{10}" title="Please enter a 10-digit phone number."></div>
      </div>
      <div class="button-group">
        <button type="button" class="btn btn-secondary btn-prev">Previous</button>
        <button type="button" class="btn btn-primary btn-next">Next</button>
        <button type="submit" class="btn btn-primary btn-submit">Submit</button>
      </div>
    </form>
  </div>
  <div id="thankyou-backdrop">
    <div id="thankyou-card">
      <h3>Thank you! üéâ</h3>
      <p>Your ID request has been submitted. Our HR team will review and process your card. You‚Äôll also receive an email notification.</p>
      <button id="thankyou-close">Close</button>
    </div>
  </div>
  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz27TXe_qp3Q5fWPT12Mlzj22UsH-LKRvgB1zwXRvHs5oB3bJdWfL8om7WIdX4tCK8Oqw/exec';

    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('id-request-form');
      const formSteps = document.querySelectorAll('.form-step');
      const prevBtn = document.querySelector('.btn-prev');
      const nextBtn = document.querySelector('.btn-next');
      const submitBtn = document.querySelector('.btn-submit');
      const progressSteps = document.querySelectorAll('.progress-bar .step');
      const progressLine = document.getElementById('progress-line');
      const buttonGroup = document.querySelector('.button-group');
      const thankYouModal = document.getElementById('thankyou-backdrop');
      const thankYouCloseBtn = document.getElementById('thankyou-close');
      const photoInput = document.getElementById('photo-upload');
      const photoPreview = document.getElementById('photo-preview');
      const photoPreviewContainer = document.getElementById('photo-preview-container');
      let currentStep = 0;

      function updateFormView() {
        formSteps.forEach((step, i) => step.classList.toggle('active', i === currentStep));
        progressSteps.forEach((step, i) => step.classList.toggle('active', i <= currentStep));
        const active = document.querySelectorAll('.progress-bar .step.active').length;
        progressLine.style.width = active > 1 ? ((active - 1) / (progressSteps.length - 1)) * 50 + '%' : '0%';
        prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
        nextBtn.style.display = currentStep === formSteps.length - 1 ? 'none' : 'inline-block';
        submitBtn.style.display = currentStep === formSteps.length - 1 ? 'inline-block' : 'none';
        buttonGroup.style.justifyContent = currentStep === 0 ? 'flex-end' : 'space-between';
      }

      function validateStep() {
        let ok = true;
        formSteps[currentStep].querySelectorAll('[required]').forEach(el => {
          if (!el.checkValidity()) { el.classList.add('invalid'); ok = false; } else { el.classList.remove('invalid'); }
        });
        return ok;
      }

      nextBtn.addEventListener('click', () => { if (validateStep() && currentStep < formSteps.length - 1) { currentStep++; updateFormView(); }});
      prevBtn.addEventListener('click', () => { if (currentStep > 0) { currentStep--; updateFormView(); }});

      photoInput.addEventListener('change', () => {
        const f = photoInput.files && photoInput.files[0];
        if (f) {
          const r = new FileReader();
          r.onload = e => { photoPreview.src = e.target.result; photoPreviewContainer.style.display = 'block'; };
          r.readAsDataURL(f);
        } else {
          photoPreviewContainer.style.display = 'none';
        }
      });

      async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result); // data URL
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validateStep()) { alert('Please fill all required fields.'); return; }

        const fileObj = (photoInput.files && photoInput.files[0]) ? photoInput.files[0] : null;
        if (!fileObj) { alert('Please attach a valid photo.'); return; }

        prevBtn.disabled = nextBtn.disabled = submitBtn.disabled = true;
        const originalSubmitText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        const spinner = document.createElement('span'); spinner.className = 'spinner'; submitBtn.appendChild(spinner);

        // First attempt: multipart/form-data
        const fd = new FormData(form);
        fd.set('photo', fileObj, fileObj.name || 'photo.jpg');

        async function sendMultipart() {
          const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
          try { return await res.json(); } catch { return { status: 'error', message: 'parse' }; }
        }
        async function sendJSON() {
          const b64 = await fileToBase64(fileObj);
          const payload = {
            _payloadType: 'jsonBase64',
            entity: form.entity.value,
            name: form.name.value,
            designation: form['designation'].value,
            'emp-code': form['emp-code'].value,
            'contact-number': form['contact-number'].value,
            'present-address': form['present-address'].value,
            'office-address': form['office-address'].value,
            'blood-group': form['blood-group'].value,
            'emergency-contact': form['emergency-contact'].value,
            photo_b64: b64,
            photo_mime: fileObj.type || 'image/jpeg',
            photo_name: fileObj.name || 'photo.jpg'
          };
          const res = await fetch(WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          return await res.json();
        }

        try {
          let data = await sendMultipart();
          // If backend still says no file, retry using JSON base64
          if (!(data && data.status === 'success')) {
            const msg = (data && data.message) ? String(data.message).toLowerCase() : '';
            if (msg.includes('did not receive') || msg.includes('no valid file') || msg.includes('unsupported')) {
              data = await sendJSON();
            }
          }

          if (data.status === 'success') {
            thankYouModal.style.display = 'flex';
          } else {
            alert('Error: ' + (data.message || 'Unknown error.'));
          }
        } catch (err) {
          console.error(err);
          alert('Network or server error. Please try again.');
        } finally {
          submitBtn.disabled = false; submitBtn.textContent = originalSubmitText;
        }
      });

      thankYouCloseBtn.addEventListener('click', () => {
        thankYouModal.style.display = 'none'; form.reset(); currentStep = 0; updateFormView();
        prevBtn.disabled = nextBtn.disabled = submitBtn.disabled = false;
        photoPreviewContainer.style.display = 'none';
      });

      updateFormView();
    });
  </script>
</body>
</html>
